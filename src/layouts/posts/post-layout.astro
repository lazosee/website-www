---
import '@/styles/post.css';
import { format } from '@/utils/date';
import { blog_url } from '@/utils/urls';
import type { MarkdownHeading } from 'astro';
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import { getEntries } from 'astro:content';
import { getEntry } from 'astro:content';

type Props = {
    slug: CollectionEntry<"posts">['slug']
    frontmatter: CollectionEntry<"posts">['data']
    headings: MarkdownHeading[]
}
const { slug, frontmatter, headings } = Astro.props;
const category = await getEntry('categories', frontmatter.category)
---

<div class="flex flex-row gap-4">
    <aside class="hidden fixed top-0 left-0 md:relative md:block md:inset-auto w-md h-[inherit] bg-slate-800 m-3 px-2 py-4 rounded-xl">
        <div class="m-2">
            {headings && (
                <h3 class="text-xl font-light first-letter:uppercase leading-relaxed my-4">in this article</h3>
                <hr />
                <ol type="I" class="flex flex-col list-[lower-roman] my-2">
                    {headings.map((h, i) => (
                        <li class=""  class:list={[
                                "text-[1rem] my-1.5 list-item list-inside", 
                                { 'ml-0': h.depth == 1 } ,
                                { 'ml-2': h.depth == 2 } ,
                                { 'ml-4': h.depth == 3 } ,
                                { 'ml-6': h.depth == 4 } ,
                                { 'ml-8': h.depth == 5 } ,
                                { 'ml-10': h.depth == 6 } ,
                            ]}>
                            <a href={`#${h.slug}`} class:list={[
                                "text-[1rem] my-1.5 hover:underline focus:underline underline-offset-1"
                                ]}>
                                <span class="">{h.text}</span>
                            </a>
                        </li>
                    ))}
                </ol>
            )}
        </div>
    </aside>
    <main class="flex-1 block content-center justify-items-center items-center justify-center w-full h-full overflow-x-hidden">
        <header class="mx-1 my-4">
            <div class="block content-center justify-items-center m-1">
                <div class="flex flex-wrap items-center w-full gap-0 font-light text-md text-blue-700 dark:text-blue-300 bg-slate-400/20 dark:bg-slate-800/40 rounded-md p-2 sm:px-4">
                    <a href="/" class="hover:underline focus:underline underline-offset-2 decoration-1">
                        <span class="capitalize font-inter">home</span>
                    </a>
                    <svg xmlns="http://www.w3.org/2000/svg" height="1.6rem" width="1.6rem" viewBox="0 -960 960 960" class="fill-black/70 dark:fill-white/70 transform rotate-180">
                        <path d="M560-240 320-480l240-240 56 56-184 184 184 184-56 56Z"/>
                    </svg>
                    <a href="/posts" class="hover:underline focus:underline underline-offset-2 decoration-1">
                        <span class="capitalize font-inter">posts</span>
                    </a>
                    <svg xmlns="http://www.w3.org/2000/svg" height="1.6rem" width="1.6rem" viewBox="0 -960 960 960" class="fill-black/70 dark:fill-white/70 transform rotate-180">
                        <path d="M560-240 320-480l240-240 56 56-184 184 184 184-56 56Z"/>
                    </svg>
                    <a href={blog_url(slug, frontmatter.published_at)} class="hover:underline focus:underline underline-offset-2 decoration-1">
                        <span class="capitalize font-inter">{frontmatter.title}</span>
                    </a>
                </div>
                <a href={`/posts?category=${category?.data.slug ?? frontmatter.category}`} class="block w-fit text-center m-2 mt-4 p-2 px-6 rounded-md bg-slate-400/60 dark:bg-slate-600/60">
                    {category?.data.title ?? frontmatter.category}
                </a>
                <h1 class="block w-20/21 text-5xl leading-tight text-balance">
                    {frontmatter.title}
                </h1>
                <div class="flex w-20/21 my-6 justify-between items-center">
                    <time class="">
                        {frontmatter.published_at.toLocaleDateString(undefined, {dateStyle: "medium"})}
                    </time>
                    <span class="">{`2 min read`}</span>
                </div>
                <div class="img self-center block w-full m-4 aspect-video rounded-xl bg-slate-500 dark:bg-slate-800 content-center justify-items-center text-center text-7xl border overflow-hidden">
                    <Image src={frontmatter.cover} alt={frontmatter.title} quality={100} format='avif' class="inline-block w-full h-full aspect-auto object-cover object-center" />
                </div>
            </div>
        </header>
        <slot />
        <footer class="block w-full p-1">
            {frontmatter.related && (
                <div class="block mx-1 my-3 px-1 py-4">
                    <h3 class="block uppercase text-3xl leading-relaxed my-6">
                        related posts
                    </h3>
                    <div class="block">
                        {frontmatter.related.map(async (rel, i) => {
                            const post = await getEntry('posts', rel);

                            return post ? (
                                <article class="bg-current/20 rounded-md mx-1 my-4 pb-4 p-2">
                                    <h4 class="text-2xl!">
                                        <a href={blog_url(post.slug, post.data.published_at)} class="underline decoration-1 underline-offset-2">{post?.data.title}</a>
                                    </h4>
                                    <div class="flex items-center-safe justify-between mx-2 text-md font-lora text-current/60">
                                        <time class="text-md" datetime={post.data.published_at.toISOString()}>
                                            {format(post.data.published_at)}
                                        </time>
                                        <span class="">{'3 min read'}</span>
                                    </div>
                                </article>
                            ) : null
                        })}
                    </div>
                </div>
            )}
        </footer>
    </main>
</div>