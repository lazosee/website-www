---
import Chart from '@/components/google-charts/chart.astro'
import { getVisits, processVisits } from '@/db/mongo/select'
import '@/styles/global.css'

export const prerender = false

const visits = processVisits(await getVisits())

// Helper functions for parsing user agent
function getBrowser(ua: string | undefined) {
	if (!ua) return 'Unknown'
	if (ua.includes('Firefox')) return 'Firefox'
	if (ua.includes('SamsungBrowser')) return 'Samsung Browser'
	if (ua.includes('Opera') || ua.includes('OPR')) return 'Opera'
	if (ua.includes('Edge')) return 'Edge'
	if (ua.includes('Chrome')) return 'Chrome'
	if (ua.includes('Safari')) return 'Safari'
	return 'Unknown'
}

function getOs(ua: string | undefined) {
	if (!ua) return 'Unknown'
	if (ua.includes('Windows')) return 'Windows'
	if (ua.includes('Mac OS')) return 'Mac OS'
	if (ua.includes('Linux')) return 'Linux'
	if (ua.includes('Android')) return 'Android'
	if (ua.includes('like Mac OS X')) return 'iOS' // for iPhone/iPad
	return 'Unknown'
}

const visitsByMonth = visits.reduce(
	(acc, visit) => {
		const month = new Date(visit.date).toLocaleString('default', { month: 'long' })
		acc[month] = (acc[month] || 0) + 1
		return acc
	},
	{} as Record<string, number>,
)

const last12Months = Array.from({ length: 12 }, (_, i) => {
	const d = new Date()
	d.setMonth(d.getMonth() - i)
	return d.toLocaleString('default', { month: 'long' })
}).reverse()

const visitsPerMonthData = [
	['Month', 'Visits'],
	...last12Months.map(month => [month, visitsByMonth[month] || 0]),
]

const visitsByCountry = visits.reduce(
	(acc, visit) => {
		acc[visit.country] = (acc[visit.country] || 0) + 1
		return acc
	},
	{} as Record<string, number>,
)

const top10Countries = Object.entries(visitsByCountry)
	.sort(([, a], [, b]) => b - a)
	.slice(0, 10)

const top10CountriesData = [['Country', 'Visits'], ...top10Countries]

const visitsByPage = visits.reduce(
	(acc, visit) => {
		acc[visit.page] = (acc[visit.page] || 0) + 1
		return acc
	},
	{} as Record<string, number>,
)

const pageVisitsData = [['Page', 'Visits'], ...Object.entries(visitsByPage)]

const visitsByContinent = visits.reduce(
	(acc, visit) => {
		const continent = visit.continent || 'Unknown'
		acc[continent] = (acc[continent] || 0) + 1
		return acc
	},
	{} as Record<string, number>,
)

const continentVisitsData = [['Continent', 'Visits'], ...Object.entries(visitsByContinent)]

const visitsByBrowser = visits.reduce(
	(acc, visit) => {
		const browser = getBrowser(visit.user_agent)
		acc[browser] = (acc[browser] || 0) + 1
		return acc
	},
	{} as Record<string, number>,
)

const browserVisitsData = [['Browser', 'Visits'], ...Object.entries(visitsByBrowser)]

const visitsByOs = visits.reduce(
	(acc, visit) => {
		const os = getOs(visit.user_agent)
		acc[os] = (acc[os] || 0) + 1
		return acc
	},
	{} as Record<string, number>,
)

const osVisitsData = [['OS', 'Visits'], ...Object.entries(visitsByOs)]
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Admin Dashboard</title>
		<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
		<script type="text/javascript">
			google.charts.load('current', { packages: ['corechart'] })
		</script>
	</head>
	<body class="antialised bg-gray-100">
		<main class="block w-full max-w-10/11 mx-auto p-4">
			<h1 class="text-3xl font-bold mb-8">Admin Dashboard</h1>
			<div class="grid grid-cols-1 gap-8">
				<div class="bg-white p-4 rounded-lg shadow-lg">
					<h2 class="text-xl font-semibold mb-4">Visits per Month</h2>
					<Chart
						chartType="LineChart"
						data={visitsPerMonthData}
						options={{ title: 'Visits per Month' }}
						id="visitsPerMonth"
					/>
				</div>
				<div class="bg-white p-4 rounded-lg shadow-lg">
					<h2 class="text-xl font-semibold mb-4">Top 10 Countries</h2>
					<Chart
						chartType="BarChart"
						data={top10CountriesData}
						options={{ title: 'Top 10 Countries' }}
						id="topCountries"
					/>
				</div>
				<div class="bg-white p-4 rounded-lg shadow-lg">
					<h2 class="text-xl font-semibold mb-4">Page Visits</h2>
					<Chart
						chartType="ColumnChart"
						data={pageVisitsData}
						options={{ title: 'Page Visits' }}
						id="pageVisits"
					/>
				</div>
				<div class="bg-white p-4 rounded-lg shadow-lg">
					<h2 class="text-xl font-semibold mb-4">Visits by Continent</h2>
					<Chart
						chartType="PieChart"
						data={continentVisitsData}
						options={{ title: 'Visits by Continent', pieHole: 0.4 }}
						id="continentVisits"
					/>
				</div>
				<div class="bg-white p-4 rounded-lg shadow-lg">
					<h2 class="text-xl font-semibold mb-4">Visits by Browser</h2>
					<Chart
						chartType="PieChart"
						data={browserVisitsData}
						options={{ title: 'Visits by Browser' }}
						id="browserVisits"
					/>
				</div>
				<div class="bg-white p-4 rounded-lg shadow-lg">
					<h2 class="text-xl font-semibold mb-4">Visits by OS</h2>
					<Chart
						chartType="PieChart"
						data={osVisitsData}
						options={{ title: 'Visits by OS', is3D: true }}
						id="osVisits"
					/>
				</div>
			</div>
		</main>
	</body>
</html>
