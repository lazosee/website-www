---
import { MainLayout, PostLayout } from "@/layouts";
import type { Meta } from "@/types/head";
import { titleTemplate } from "@/utils/functions";
import { calcReadingTime } from "@lueur/blog-utils";
import type { GetStaticPaths } from "astro";
import { getImage } from "astro:assets";
import { getCollection } from "astro:content";

export const prerender = true

export const getStaticPaths = (async() => {
    const posts = await getCollection('posts')
    const paths = posts
        .sort((a, b) => b.data.published_at.valueOf() - a.data.published_at.valueOf())
        .map((post, i) => ({
         params: { year: post.data.published_at.getUTCFullYear().toString(), slug: post.slug },
         props: { 
            blog: post, 
            previous: i > 0 ? {
                slug: posts[i-1].slug, 
                title: posts[i-1].data.title, 
                year: posts[i-1].data.published_at
            } : null ,
            next: (i < (posts.length - 1)) ? {
                slug: posts[i+1].slug, 
                title:  posts[i+1].data.title, 
                year:  posts[i+1].data.published_at 
            } : null,
        }
    }));
    // ðŸ‘‡ Check the generated paths here!
    console.log('Generated Paths:', paths.map(p => `/posts/${p.params.year}/${p.params.slug}`)) 
    return paths;
}) satisfies GetStaticPaths;

const { year, slug } = Astro.params;
if (!slug || !year) return new Response('Invalid blog slug or year', { status: 404 })

const { blog, next, previous } = Astro.props

if (!blog) return new Response(`Blog with slug ${slug} not found!`, { status: 404 });

const { Content, headings, remarkPluginFrontmatter } = await blog.render()
const reading_time = calcReadingTime(blog.body)

// Metadata
const title = titleTemplate(blog.data.title)
const { src: cover } = await getImage({ src: blog.data.cover, format: "avif", fit: "cover", inferSize: true, quality: 100 })
const metas: Meta[] = [
		{ name: "title", content: blog.data.title },
		{ name: "description", content: blog.data.snippet },
		{ name: "canonical", content: "https://www.lazaroosee.xyz/" },
		{ name: "type", content: "article" },
		{ name: "author", content: "Lazaro Osee" },
		{ name: "copyright", content: "Lazaro Osee" },
		{ name: "robots", content: "index, follow" },
		{ name: "image", content: cover },
		{ name: "og:title", content: blog.data.title },
		{ name: "og:description", content: blog.data.snippet },
		{ name: "og:image", content: cover },
		{ name: "og:url", content: "https://www.lazaroosee.xyz" },
		{ name: "twitter:card", content: "summary_large_image" },
		{ name: "twitter:title", content: blog.data.title },
		{ name: "twitter:decsription", content: blog.data.snippet },
		{ name: "twitter:image", content: cover },
	]
---

<MainLayout
	title={title}
	{metas}
>
    <PostLayout
        slug={blog.slug} 
        frontmatter={blog.data} 
        reading-time={reading_time} 
        {headings}
        {next}
        {previous}
    >
        <Content />
    </PostLayout>
</MainLayout>
